(()=>{var k=Object.defineProperty;var te=s=>k(s,"__esModule",{value:!0});var m=(s,e)=>()=>(s&&(e=s(s=0)),e);var oe=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),D=(s,e)=>{te(s);for(var t in e)k(s,t,{get:e[t],enumerable:!0})};var O,v,P=m(()=>{O=class{constructor(e,t,o="",i="",n=""){let c=2**t;this.prefix=o,this.sufix=i,this.separator=n,this.base=Math.min(c,e),this.padLength=Math.ceil(Math.log(c)/Math.log(this.base))}encode(e,t=this.prefix,o=this.sufix,i=this.separator){let n=[];for(let c of e){let a=c.toString(this.base).toUpperCase().padStart(this.padLength,"0");n.push(`${t}${a}${o}`)}return n.join(i)}*parse(e,t=this.prefix,o=this.sufix,i=this.separator){let n=e.slice(t.length,e.length-o.length),c=o+i+t,a=null;if(c.length>0)a=n.split(c);else{let d=new RegExp(`.{${this.padLength}}`,"g");a=n.match(d)}for(let d of a)yield parseInt(d,this.base)}},v=O});var h,u=m(()=>{h=class{observers={};on(e,t){return e in this.observers||(this.observers[e]=[]),this.observers[e].push(t),this}emit(e,...t){if(e in this.observers)for(let o of this.observers[e])o.call(this,...t);if("all"in this.observers)for(let o of this.observers.all)o.call(this,...t,e)}}});var x,A=m(()=>{u();x=class extends h{constructor(e){super();return new Proxy(e,{get:(t,o)=>(this.emit("get",t,o),e[o]||this[o]),set:(t,o,i)=>(e[o]=i,this.emit("set",t,o,i),!0)})}}});var p,N=m(()=>{p=class{static fromBooleans(e){let t=0;for(let o in e)t+=e[o]?2**(e.length-o-1):0;return t}static*toBooleans(e,t){for(let o of e){let i=o.toString(2).padStart(t,"0");for(let n of i)yield n=="1"}}static*getChunks(e,t){for(let o=0;o<e.length;o+=t)yield this.fromBooleans(e.slice(o,o+t))}}});var y,H=m(()=>{P();A();u();N();y=class extends h{constructor(e,t){super();this.width=e,this.height=t,this.encoder=new v(36,e);let o=new Array(e*t).fill(!1);this.buffer=new x(o)}get binaries(){return p.getChunks(this.buffer,this.width)}set binaries(e){let t=p.toBooleans(e,this.width),o=0;for(let i of t)this.buffer[o]=i,o++}setBinaries(e,t=32,o=!1){let i=p.toBooleans(e,this.width),n=this.height/this.width;return new Promise(c=>{let a=0;for(let d of i){let I=a%this.width,ee=Math.floor(a/this.width),$=t*(I*n+ee/n);setTimeout(b=>this.buffer[b]=!this.buffer[b],$,a),setTimeout(b=>this.buffer[b]=d,t+$,a),a===this.width*this.height-1&&setTimeout(()=>{c(),o||this.emit("change")},t+$,this),a++}})}get code(){return this.encoder.encode(this.binaries)}set code(e){this.binaries=this.encoder.parse(e)}async setCode(e,t=!1){await this.setBinaries(this.encoder.parse(e),32,t)}get pixels(){let e=getComputedStyle(document.documentElement).getPropertyValue("color");return this.getPixels(this.binaries,e)}toggleDot(e,t,o=!1){let i=t||!this.buffer[e],n=this.buffer[e];this.buffer[e]=i,!o&&n!==i&&this.emit("input")}async clear(e=!1){let t=new Array(this.height).fill(0);await this.setBinaries(t,32,!0),e||this.emit("clear")}getPixels(e=this.binaries,t="#000"){let o=p.toBooleans(e,this.width),i=document.createElement("canvas"),n=i.getContext("2d");i.width=this.width,i.height=this.height,n.fillStyle=t;let c=0;for(let a of o){if(a){let d=c%i.width,I=Math.floor(c/i.width);n.fillRect(d,I,1,1)}c++}return i.toDataURL()}}});var V,U,G=m(()=>{u();V=class extends h{records=[];pointer=-1;constructor(e,t,o=!0){super();this.target=e,this.key=t,this.update=o,this.recordStep()}recordStep(e=this.target[this.key]){this.pointer++,this.records[this.pointer]=e,this.clearRedo(),this.emit("step",e)}undo(e=1){if(this.pointer-e>=0){let t=this.records[this.pointer-e];this.update&&(this.target[this.key]=t),this.pointer-=e,this.emit("undo",t)}}redo(e=1){if(this.pointer+e<=this.records.length-1){let t=this.records[this.pointer+e];this.update&&(this.target[this.key]=t),this.pointer+=e,this.emit("redo",t)}}clearRedo(){this.records.length=this.pointer+1}},U=V});var E,X=m(()=>{u();E=class extends h{dispatch(e,t,{target:o}){let i=[...o.parentNode.children],n=()=>{this.emit("start",e,t);for(let d of i)d.addEventListener("mouseenter",c,{once:!0})},c=({target:d})=>{e=i.indexOf(d),d.focus(),this.emit("drawing",e,t)},a=()=>{o.removeEventListener("mouseleave",n);for(let d of i)d.removeEventListener("mouseenter",c);this.emit("end",e,t)};o.addEventListener("mouseleave",n,{once:!0}),window.addEventListener("mouseup",a,{once:!0})}}});var w,T=m(()=>{u();w=class extends h{constructor(e){super();let t=document.getElementById(e);this.parent=t.parentNode,this.prev=t.previousSibling,this.next=t.nextSibling,this.node=t.content.firstElementChild.cloneNode(!0),t.remove(),this.emit("created",this.node)}mount(e=this.parent,t,...o){let i=this.node.cloneNode(!0);t===void 0?e.appendChild(i):e.insertBefore(i,this.next),this.emit("mount",i,...o)}}});var F={};D(F,{default:()=>l});async function ce(){r.width===5&&r.height===8&&(await r.setCode("DLI449LM",!0),await new Promise(s=>setTimeout(s,1024)),await r.clear(!0)),z&&r.setCode(z)}var _,se,ie,r,L,q,M,S,Y,re,ne,z,l,R=m(()=>{H();G();P();X();T();_=new URLSearchParams(location.search),se=Math.abs(parseInt(_.get("width")))||5,ie=Math.abs(parseInt(_.get("height")))||8,r=new y(se,ie),L=new w("character-dot-template"),q=new E;L.on("mount",(s,e)=>{s.addEventListener("click",()=>{let t=!r.buffer[e];r.toggleDot(e,t)}),s.addEventListener("pointerdown",t=>{let o=!r.buffer[e];q.dispatch(e,o,t)}),r.buffer.on("set",(t,o,i)=>{o===e&&(i?s.classList.add("active"):s.classList.remove("active"))})});q.on("all",(s,e,t)=>{t!=="end"&&r.toggleDot(s,e)});for(let s in r.buffer)L.mount(L.parent,L.next,s);M=new U(r,"code");r.on("all",()=>{M.recordStep()});document.addEventListener("keydown",({ctrlKey:s,key:e})=>{s&&(e==="z"?M.undo():e==="y"&&M.redo())});S=document.getElementById("character-code"),Y=new v(16,r.width,"<small>0x</small><strong>","</strong>",", ");S.addEventListener("click",()=>{window.getSelection().selectAllChildren(S)});r.buffer.on("set",()=>{S.innerHTML=Y.encode(r.binaries)});S.innerHTML=Y.encode(r.binaries);re=document.getElementById("clear-button");re.addEventListener("click",()=>r.clear());ne=document.getElementById("share-character-button");ne.addEventListener("click",s=>{s.preventDefault(),window.navigator.share({url:`https://lucianofelix.com.br/XAR/?width=${r.width}&height=${r.height}&code=${r.code}`})});document.documentElement.style.setProperty("--character-width",r.width);document.documentElement.style.setProperty("--character-height",r.height);z=_.get("code");ce();l=r});var ae,j,J=m(()=>{u();ae={name:void 0,legacyNames:[],encode:void 0,decode:void 0},j=class extends h{constructor(e){super();this.config={...ae,...e},this.buffer=void 0,this.updateLegacy(),this.load()}updateLegacy(){for(let e of this.config.legacyNames){let t=window.localStorage.getItem(e);if(t){let o=window.localStorage.getItem(this.config.name)||"";window.localStorage.setItem(this.config.name,o+t),window.localStorage.removeItem(e)}}}save(){let e=this.config.encode(this.buffer);window.localStorage.setItem(this.config.name,e),this.emit("save",this)}load(){let e=window.localStorage.getItem(this.config.name),t=this.config.decode(e);this.buffer=t,this.emit("load",t)}store(e,t=this.buffer.length){this.buffer[t]=e,this.save(),this.emit("store",e,t)}remove(e){this.buffer.splice(e,1),this.save(),this.emit("remove",e)}}});var B,K=m(()=>{u();B=class extends h{dispatch(...e){let t=!1,o=setTimeout(()=>t=!0,450);window.addEventListener("pointerup",async i=>{clearTimeout(o),t?this.emit("press",...e,i):this.emit("click",...e,i)},{once:!0})}}});var Q={};D(Q,{default:()=>de});var f,C,le,g,he,de,W=m(()=>{J();K();T();R();f=new j({name:`com.lucianofelix.xar-collection:${l.width}x${l.height}`,legacyNames:[`XAR_${l.width}x${l.height}`,`com.lucianofelix.xar-storage:${l.width}x${l.height}`],encode(s=[]){let e="";for(let t of s)e+=t.code;return e},decode(s){let e=l.encoder.padLength*l.height,t=new RegExp(`.{${e}}`,"g"),o=s?.match(t),i=[];if(o?.length){let n=getComputedStyle(document.documentElement).getPropertyValue("color");for(let c of o){let a=l.getPixels(l.encoder.parse(c),n);i.push({code:c,pixels:a})}}return i}}),C=document.getElementById("collection-section-name");C.addEventListener("input",({target:s})=>{localStorage.setItem("com.lucianofelix.xar-collection_name",s.innerText)});C.addEventListener("focus",()=>{window.getSelection().selectAllChildren(C)});C.addEventListener("keydown",({target:s,key:e})=>{e==="Enter"&&s.blur()});le=document.getElementById("store-button");le.addEventListener("click",()=>{l.setBinaries(l.binaries,32,!0),f.store({code:l.code,pixels:l.pixels})});g=new w("collection-item-template"),he=new B().on("click",s=>{let{code:e}=f.buffer[s];l.code!==e&&l.setCode(e)}).on("press",(s,e)=>{e.preventDefault(),f.remove(s)});g.on("mount",(s,e)=>{let t=s.querySelector("img");t.src=e.pixels,s.addEventListener("pointerdown",()=>{let o=f.buffer.indexOf(e);he.dispatch(o)}),f.on("remove",()=>{f.buffer.indexOf(e)===-1&&s.remove()})});f.on("store",s=>{g.mount(g.parent,g.next,s)});for(let s of f.buffer)g.mount(g.parent,g.next,s);de=f});var ue=oe(Z=>{var me=document.getElementById("collection-section-name");me.innerText=localStorage.getItem("com.lucianofelix.xar-collection_name")||"MY CHARACTERS";async function fe(){await Promise.resolve().then(()=>(R(),F)),await Promise.resolve().then(()=>(W(),Q))}fe.call(Z)});ue();})();
